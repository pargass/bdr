SET statement_timeout = 0;
SET lock_timeout = 0;
SET idle_in_transaction_session_timeout = 0;
Ces commandes dÃ©sactivent certains dÃ©lais d'attente pour Ã©viter que les requÃªtes longues ne soient interrompues.

sql
Copy
Edit
SET client_encoding = 'UTF8';
SET standard_conforming_strings = on;
DÃ©finit l'encodage des caractÃ¨res Ã  UTF-8.

Active le standard SQL pour les chaÃ®nes (utile pour Ã©viter des comportements bizarres avec les apostrophes, par exemple).

sql
Copy
Edit
SELECT pg_catalog.set_config('search_path', '', false);
Supprime tous les chemins de recherche par dÃ©faut pour Ã©viter des confusions avec d'autres schÃ©mas (on force Ã  bosser dans le bon schÃ©ma).

sql
Copy
Edit
SET check_function_bodies = false;
SET xmloption = content;
SET client_min_messages = notice;
SET row_security = off;
DÃ©sactive la vÃ©rification des corps de fonctions lors de leur crÃ©ation (utile quand les objets qu'elles utilisent ne sont pas encore crÃ©Ã©s).

DÃ©finit comment le XML est traitÃ©.

RÃ©duit la verbositÃ© des messages affichÃ©s par PostgreSQL.

DÃ©sactive la sÃ©curitÃ© par ligne (pas utile ici mais peut Ãªtre pour certains cas dâ€™usage avancÃ©s).

ğŸ§± CrÃ©ation du schÃ©ma et des tables
sql
Copy
Edit
DROP SCHEMA IF EXISTS crous CASCADE;
CREATE SCHEMA crous;
SET schema 'crous';
Supprime le schÃ©ma crous sâ€™il existe (et tout ce quâ€™il contient).

CrÃ©e un nouveau schÃ©ma crous.

Dit Ã  PostgreSQL dâ€™utiliser ce schÃ©ma par dÃ©faut.

ğŸ“‹ Table Tarif
sql
Copy
Edit
CREATE TABLE Tarif(...);
CrÃ©e une table des tarifs possibles pour les repas.

tarif_repas doit Ãªtre â‰¥ 0.

Les insert into suivants insÃ¨rent 4 tarifs diffÃ©rents.

ğŸ‘¤ Table Personne
sql
Copy
Edit
CREATE TABLE Personne(...);
Chaque personne a un nom, prÃ©nom, tarif associÃ©, solde, et une indication sâ€™il possÃ¨de une carte (possede_carte, boolÃ©en encodÃ© en 0/1).

Les insert suivants ajoutent quelques personnes cÃ©lÃ¨bres avec un tarif et un solde.

ğŸ’³ Table CarteMS
sql
Copy
Edit
CREATE TABLE CarteMS(...);
ReprÃ©sente les cartes (type CROUS).

LiÃ©e Ã  une personne (proprietaire).

Attribut activee : boolÃ©en (0 ou 1).

Les insert suivants ajoutent des cartes Ã  certaines personnes. Newton a deux cartes (dont une dÃ©sactivÃ©e), d'autres une seule, parfois dÃ©sactivÃ©e.

ğŸ”„ Mise Ã  jour du champ possede_carte
sql
Copy
Edit
UPDATE personne
SET possede_carte = (SELECT COALESCE(SUM(activee), 0) FROM cartems WHERE proprietaire = id_personne);
Calcule le nombre de cartes actives pour chaque personne et met Ã  jour possede_carte en consÃ©quence.

ğŸ½ï¸ Table Consommation
sql
Copy
Edit
CREATE TABLE Consommation(...);
ReprÃ©sente une consommation de repas avec :

lâ€™identifiant de carte utilisÃ©e,

le moment,

le montant payÃ©.

Le montant est calculÃ© automatiquement par un trigger plus tard.

Les insert suivants ajoutent quelques consommations fictives.

ğŸ” Trigger : gestion automatique de possede_carte
sql
Copy
Edit
CREATE FUNCTION maj_possede_carte()
Fonction dÃ©clenchÃ©e aprÃ¨s insertion ou mise Ã  jour sur CarteMS.

Compte les cartes actives dâ€™un utilisateur et met Ã  jour possede_carte.

LÃ¨ve une exception si une personne a plus dâ€™une carte active.

sql
Copy
Edit
CREATE TRIGGER trigger_insert_cartems ...
CREATE TRIGGER trigger_update_cartems ...
Lie la fonction aux Ã©vÃ©nements d'insertion et de mise Ã  jour sur la table CarteMS.

ğŸ›¡ï¸ Trigger : validation des consommations
sql
Copy
Edit
CREATE FUNCTION conso_valide()
DÃ©clenchÃ©e avant lâ€™insertion dans la table Consommation.

VÃ©rifie :

que la carte est active ;

que le solde est suffisant ;

Si tout est OK :

DÃ©duit le montant du solde de la personne ;

InsÃ¨re le montant correspondant au tarif.

ğŸ“Š Fonction afficher_conso
sql
Copy
Edit
CREATE FUNCTION afficher_conso(start_, end_, id)
Affiche la consommation mensuelle dâ€™une personne donnÃ©e entre deux dates.

Utilise generate_series() pour gÃ©nÃ©rer les mois entre start_ et end_.

Pour chaque mois, affiche le total des consommations.

Renvoie true (t) si la personne a au moins une carte active, false (f) sinon.

ğŸ” Exemples de tests
Des requÃªtes de test Ã  la fin montrent :

Comment les triggers rÃ©agissent (erreurs si carte dÃ©sactivÃ©e ou solde insuffisant).

Comment la fonction afficher_conso affiche les infos par mois.